# Port Digger - macOS èœå•æ ç«¯å£ç›‘æ§å·¥å…·è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

Port Digger æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ macOS èœå•æ å·¥å…·,ç”¨äºå®æ—¶ç›‘æ§ç³»ç»Ÿä¸­æ‰€æœ‰æ­£åœ¨ç›‘å¬çš„ TCP ç«¯å£,å¹¶æä¾›å¿«é€Ÿæ“ä½œåŠŸèƒ½(æµè§ˆå™¨æ‰“å¼€ã€ç»ˆæ­¢è¿›ç¨‹ã€å¤åˆ¶ç«¯å£å·)ã€‚

## æ ¸å¿ƒéœ€æ±‚

- æ˜¾ç¤ºæ‰€æœ‰ TCP ç›‘å¬ç«¯å£åŠå¯¹åº”çš„è¿›ç¨‹åç§°
- ç‚¹å‡»èœå•æ å›¾æ ‡å±•ç¤ºç«¯å£åˆ—è¡¨
- é¼ æ ‡æ‚¬åœç«¯å£é¡¹æ—¶æ˜¾ç¤ºå­èœå•,æ”¯æŒ:åœ¨æµè§ˆå™¨æ‰“å¼€ã€å¤åˆ¶ç«¯å£å·ã€ç»ˆæ­¢è¿›ç¨‹
- ä¼˜å…ˆè€ƒè™‘è¿è¡Œæ—¶å†…å­˜å ç”¨æœ€å°åŒ–
- æ”¯æŒåæœŸæ‰©å±•è‡ªå®šä¹‰è¿›ç¨‹å‘½åæ˜ å°„

## æŠ€æœ¯æ ˆé€‰æ‹©

**æ ¸å¿ƒæŠ€æœ¯:** çº¯ Go + systray

**é€‰æ‹©ç†ç”±:**
- è¿è¡Œæ—¶å†…å­˜å ç”¨: 10-20MB (åŸç”ŸäºŒè¿›åˆ¶,æ— è¿è¡Œæ—¶ä¾èµ–)
- ç›¸æ¯” Electron (100-200MB) å’Œ Python (80-150MB) æœ‰æ˜¾è‘—ä¼˜åŠ¿
- Go å¤„ç†ç³»ç»Ÿè°ƒç”¨ä¾¿æ·,æ€§èƒ½ä¼˜ç§€
- systray åº“æä¾›åŸç”Ÿèœå•æ ·å¼

**æ ¸å¿ƒä¾èµ–åº“:**
```go
require (
    github.com/getlantern/systray           // èœå•æ  UI
    github.com/skratchdot/open-golang/open  // è·¨å¹³å°æ‰“å¼€æµè§ˆå™¨
    golang.design/x/clipboard               // å‰ªè´´æ¿æ“ä½œ
)
```

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  systray (UI)   â”‚  èœå•æ å›¾æ ‡ + èœå•ç®¡ç†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ onClick: è§¦å‘ç«¯å£æ‰«æ
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Port Scanner    â”‚  æ‰§è¡Œ lsof,è§£æç«¯å£åˆ—è¡¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Process Info    â”‚  è§£æè¿›ç¨‹åç§°,æ”¯æŒè‡ªå®šä¹‰æ˜ å°„
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Menu Builder    â”‚  åŠ¨æ€æ„å»ºèœå•é¡¹ + å­èœå•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Actions         â”‚  æ‰“å¼€æµè§ˆå™¨/ç»ˆæ­¢è¿›ç¨‹/å¤åˆ¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é¡¹ç›®ç»“æ„

```
port-digger/
â”œâ”€â”€ main.go              # å…¥å£,åˆå§‹åŒ– systray
â”œâ”€â”€ scanner/
â”‚   â””â”€â”€ scanner.go       # ç«¯å£æ‰«æé€»è¾‘
â”œâ”€â”€ process/
â”‚   â”œâ”€â”€ info.go          # è¿›ç¨‹ä¿¡æ¯æå–
â”‚   â””â”€â”€ naming.go        # è‡ªå®šä¹‰å‘½åæ˜ å°„(åæœŸæ‰©å±•)
â”œâ”€â”€ menu/
â”‚   â””â”€â”€ builder.go       # èœå•æ„å»ºé€»è¾‘
â”œâ”€â”€ actions/
â”‚   â”œâ”€â”€ browser.go       # æµè§ˆå™¨æ‰“å¼€
â”‚   â”œâ”€â”€ kill.go          # ç»ˆæ­¢è¿›ç¨‹
â”‚   â””â”€â”€ clipboard.go     # å¤åˆ¶åˆ°å‰ªè´´æ¿
â””â”€â”€ go.mod
```

### æ•°æ®åˆ·æ–°ç­–ç•¥

**æ–¹æ¡ˆ: ç‚¹å‡»æ—¶å®æ—¶è·å–**

- æ¯æ¬¡ç‚¹å‡»èœå•æ å›¾æ ‡æ—¶æ‰§è¡Œ `lsof` è·å–æœ€æ–°ç«¯å£åˆ—è¡¨
- åŠ¨æ€æ„å»ºèœå•é¡¹

**ä¼˜åŠ¿:**
- å†…å­˜å ç”¨æœ€å° (10-15MB),æ— åå°è½®è¯¢
- æ•°æ®æ°¸è¿œæ˜¯æœ€æ–°çš„
- å®ç°ç®€å•,æ— éœ€ç®¡ç†åˆ·æ–°å‘¨æœŸ

**æƒè¡¡:**
- é¦–æ¬¡ç‚¹å‡»åˆ°èœå•å±•å¼€æœ‰ 200-500ms å»¶è¿Ÿ(å¯æ¥å—)

## æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. ç«¯å£æ‰«æ (scanner/scanner.go)

**å‘½ä»¤:** `lsof -iTCP -sTCP:LISTEN -nP`
- `-iTCP`: åªæ˜¾ç¤º TCP è¿æ¥
- `-sTCP:LISTEN`: åªæ˜¾ç¤ºç›‘å¬çŠ¶æ€
- `-nP`: ä¸è§£æä¸»æœºåå’Œç«¯å£å(æé«˜é€Ÿåº¦)

**æ•°æ®ç»“æ„:**
```go
type PortInfo struct {
    Port        int     // ç«¯å£å·
    ProcessName string  // è¿›ç¨‹åç§°
    PID         int     // è¿›ç¨‹ ID
    Command     string  // å®Œæ•´å‘½ä»¤(ç”¨äºåæœŸè‡ªå®šä¹‰å‘½å)
    Protocol    string  // "TCP" æˆ– "TCP6"
}
```

**è§£æé€»è¾‘:**
1. æ‰§è¡Œå‘½ä»¤å¹¶è¯»å–è¾“å‡º
2. é€è¡Œè§£æ,æå– COMMANDã€PIDã€NAME åˆ—
3. ä» NAME åˆ—æå–ç«¯å£å· (å¦‚ `*:3000`)
4. è¿”å› `[]PortInfo`

### 2. è¿›ç¨‹åç§°å¤„ç† (process/)

**åˆæœŸå®ç° (info.go):**
- ç›´æ¥ä½¿ç”¨ lsof è¾“å‡ºçš„ COMMAND åˆ— (å¦‚ "node", "Python")
- ä¿ç•™å®Œæ•´å‘½ä»¤è¡Œå­˜å‚¨åœ¨ `Command` å­—æ®µ

**åæœŸæ‰©å±• (naming.go):**
- è¯»å–é…ç½®æ–‡ä»¶ `~/.port-digger/naming.json`
- æ”¯æŒæ¨¡å¼åŒ¹é…æ˜ å°„åˆ°è‡ªå®šä¹‰åç§°
- ç¤ºä¾‹é…ç½®:
```json
{
  "rules": [
    {"pattern": "node.*ABCBox", "name": "ABCBox"},
    {"pattern": "python.*django", "name": "Django Server"}
  ]
}
```

### 3. èœå•æ„å»º (menu/builder.go)

**èœå•ç»“æ„:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [å›¾æ ‡] Port Digger     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”„ åˆ·æ–°                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚  3000 â€¢ node            â”‚â”€â”€â”
â”‚  8080 â€¢ Python          â”‚  â”‚
â”‚  9000 â€¢ go              â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                              â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼ å­èœå•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åœ¨æµè§ˆå™¨æ‰“å¼€             â”‚
â”‚  å¤åˆ¶ç«¯å£å·               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚  ç»ˆæ­¢è¿›ç¨‹ (PID: 12345)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ˜¾ç¤ºæ ¼å¼:**
```go
// ç«¯å£å³å¯¹é½å 5å­—ç¬¦,è¿›ç¨‹åå·¦å¯¹é½
func formatPortItem(info PortInfo) string {
    portStr := fmt.Sprintf("%5d", info.Port)
    return fmt.Sprintf("%s â€¢ %s", portStr, info.ProcessName)
}

// ç¤ºä¾‹è¾“å‡º:
//  3000 â€¢ node
//  8080 â€¢ Python
// 27017 â€¢ mongod
```

**æ„å»ºé€»è¾‘:**
1. æ‰«æç«¯å£åæŒ‰ `Port` å‡åºæ’åº
2. æ·»åŠ "åˆ·æ–°"æŒ‰é’®(ç½®é¡¶)
3. æ·»åŠ åˆ†éš”çº¿
4. éå†ç«¯å£åˆ—è¡¨,ä¸ºæ¯ä¸ªç«¯å£åˆ›å»ºèœå•é¡¹åŠå­èœå•

### 4. æ“ä½œåŠŸèƒ½ (actions/)

**æµè§ˆå™¨æ‰“å¼€ (browser.go):**
```go
func OpenBrowser(port int) {
    url := fmt.Sprintf("http://localhost:%d", port)
    open.Run(url)  // è°ƒç”¨ç³»ç»Ÿé»˜è®¤æµè§ˆå™¨
}
```

**å¤åˆ¶ç«¯å£å· (clipboard.go):**
```go
func CopyToClipboard(port int) {
    clipboard.Write(clipboard.FmtText, []byte(fmt.Sprintf("%d", port)))
}
```

**ç»ˆæ­¢è¿›ç¨‹ (kill.go):**
```go
func KillProcess(pid int) error {
    // 1. å…ˆå°è¯•ä¼˜é›…ç»ˆæ­¢
    cmd := exec.Command("kill", "-15", fmt.Sprintf("%d", pid))
    err := cmd.Run()

    if err == nil {
        return nil
    }

    // 2. å¤±è´¥åˆ™é€šè¿‡ osascript è¯·æ±‚ sudo æƒé™
    script := fmt.Sprintf("kill -9 %d", pid)
    cmd = exec.Command("osascript", "-e",
        fmt.Sprintf(`do shell script "%s" with administrator privileges`, script))

    return cmd.Run()  // å¼¹å‡ºç³»ç»Ÿå¯†ç è¾“å…¥æ¡†
}
```

**æƒé™å¤„ç†æµç¨‹:**
- å…ˆå°è¯• `kill -15` (SIGTERM)
- å¤±è´¥åˆ™é€šè¿‡ `osascript` è°ƒç”¨ `sudo kill -9` (SIGKILL)
- macOS ä¼šè‡ªåŠ¨å¼¹å‡ºåŸç”Ÿæˆæƒå¯¹è¯æ¡†

## ä¸»ç¨‹åºå…¥å£

```go
func main() {
    systray.Run(onReady, onExit)
}

func onReady() {
    systray.SetIcon(getIcon())
    systray.SetTitle("Port Digger")
    systray.SetTooltip("æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„ç«¯å£")
    refreshMenu()
}

func refreshMenu() {
    systray.ResetMenu()

    // æ·»åŠ åˆ·æ–°æŒ‰é’®
    mRefresh := systray.AddMenuItem("ğŸ”„ åˆ·æ–°", "é‡æ–°æ‰«æç«¯å£")
    go func() {
        for range mRefresh.ClickedCh {
            refreshMenu()
        }
    }()

    systray.AddSeparator()

    // æ‰«æç«¯å£å¹¶æ„å»ºèœå•
    ports, err := scanner.ScanPorts()
    if err != nil {
        systray.AddMenuItem("âŒ æ‰«æå¤±è´¥", err.Error())
        return
    }

    // æ’åºå¹¶æ·»åŠ èœå•é¡¹
    sort.Slice(ports, func(i, j int) bool {
        return ports[i].Port < ports[j].Port
    })

    for _, p := range ports {
        addPortMenuItem(p)
    }
}
```

## é”™è¯¯å¤„ç†

- **æ‰«æå¤±è´¥**: åœ¨èœå•ä¸­æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯,ä¸å´©æºƒ
- **æƒé™ä¸è¶³**: osascript ä¼šè‡ªåŠ¨æç¤ºç”¨æˆ·è¾“å…¥å¯†ç 
- **æµè§ˆå™¨æ‰“å¼€å¤±è´¥**: é™é»˜å¤±è´¥
- **å‰ªè´´æ¿æ“ä½œå¤±è´¥**: é™é»˜å¤±è´¥

## æ‰“åŒ…ä¸åˆ†å‘

```bash
# ç¼–è¯‘
go build -ldflags="-s -w" -o PortDigger

# æœ€ç»ˆäºŒè¿›åˆ¶å¤§å°é¢„è®¡: 8-15MB
# è¿è¡Œæ—¶å†…å­˜å ç”¨: 10-20MB
```

## åæœŸæ‰©å±•ç‚¹

1. **è‡ªå®šä¹‰è¿›ç¨‹å‘½å**: é€šè¿‡é…ç½®æ–‡ä»¶æ”¯æŒæ¨¡å¼åŒ¹é…æ˜ å°„
2. **ç«¯å£åˆ†ç»„**: æŒ‰æœåŠ¡ç±»å‹åˆ†ç»„æ˜¾ç¤º(Web/Database/å…¶ä»–)
3. **å¿«æ·é”®æ”¯æŒ**: å…¨å±€å¿«æ·é”®å¿«é€Ÿæ‰“å¼€èœå•
4. **ç«¯å£å†å²è®°å½•**: è®°å½•æœ€è¿‘ä½¿ç”¨çš„ç«¯å£
5. **å¤šåè®®æ”¯æŒ**: æ‰©å±•æ”¯æŒ UDP ç«¯å£ç›‘æ§

## è®¾è®¡åŸåˆ™

- **YAGNI**: åˆæœŸåªå®ç°æ ¸å¿ƒåŠŸèƒ½,é¿å…è¿‡åº¦è®¾è®¡
- **è½»é‡åŒ–ä¼˜å…ˆ**: æ‰€æœ‰è®¾è®¡å†³ç­–éƒ½ä¼˜å…ˆè€ƒè™‘å†…å­˜å’Œæ€§èƒ½
- **ç”¨æˆ·ä½“éªŒ**: ç«¯å£æ’åºã€æ ¼å¼åŒ–æ˜¾ç¤ºã€å¿«é€Ÿæ“ä½œ
- **å¯æ‰©å±•æ€§**: é¢„ç•™è‡ªå®šä¹‰å‘½åç­‰æ‰©å±•æ¥å£

---

**è®¾è®¡ç¡®è®¤æ—¥æœŸ:** 2026-01-19
**é¢„æœŸå¼€å‘å‘¨æœŸ:** 2-3 å¤© (æ ¸å¿ƒåŠŸèƒ½å®ç° + æµ‹è¯•)
